// Fichier : prisma/schema.prisma (Version FINALE avec Factures + Photos + Carte)

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// --- MODÃˆLE USER ---
model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  createdAt   DateTime @default(now())

  // Relations
  properties Property[]
  contacts   Contact[]
  tasks      Task[]
  activities ActivityLog[]
  
  // ðŸ‘‡ C'est ici qu'on ajoute la ligne pour les factures
  invoices   Invoice[] 
}

// --- MODÃˆLE PROPERTY ---
model Property {
  id          Int      @id @default(autoincrement())
  address     String
  city        String?
  postalCode  String?
  price       Int
  area        Int
  rooms       Int
  bedrooms    Int
  description String?

  // Nos ajouts prÃ©cÃ©dents (Photos et Carte)
  imageUrl    String?
  latitude    Float?
  longitude   Float?
  views       Int?     @default(0)

  createdAt   DateTime @default(now())

  agent     User @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId   Int
  tasks     Task[]

  // Relation many-to-many avec Contact (propriÃ©taires)
  owners    PropertyOwner[]

  @@index([agentId])
}

// --- MODÃˆLE CONTACT ---
model Contact {
  id          Int      @id @default(autoincrement())
  firstName   String
  lastName    String
  email       String?
  phoneNumber String?
  type        String   // "BUYER" ou "SELLER"
  createdAt   DateTime @default(now())

  agent     User @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId   Int
  tasks     Task[]

  // ðŸ‘‡ C'est ici qu'on ajoute la ligne pour les factures
  invoices  Invoice[]

  // Relation many-to-many avec Property (biens possÃ©dÃ©s)
  properties PropertyOwner[]

  @@index([agentId])
}

// --- MODÃˆLE TASK ---
model Task {
  id          Int      @id @default(autoincrement())
  title       String
  dueDate     DateTime?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  agent     User @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId   Int

  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  contactId   Int?

  property    Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  propertyId  Int?

  @@index([agentId])
  @@index([contactId])
  @@index([propertyId])
}

// --- NOUVEAU MODÃˆLE FACTURE (INVOICE) ---
model Invoice {
  id          Int      @id @default(autoincrement())
  ref         String   // NumÃ©ro de facture
  amount      Int      // Montant
  description String   // Motif
  status      String   @default("PENDING") // PENDING ou PAID
  createdAt   DateTime @default(now())

  // Liens
  contact     Contact @relation(fields: [contactId], references: [id])
  contactId   Int

  agent       User    @relation(fields: [agentId], references: [id])
  agentId     Int
}

// --- MODÃˆLE HISTORIQUE D'ACTIVITÃ‰ ---
model ActivityLog {
  id          Int      @id @default(autoincrement())
  action      String   // Ex: "CRÃ‰ATION_BIEN", "SUPPRESSION_CONTACT"
  description String   // Ex: "A ajoutÃ© le bien 10 rue de la Paix"
  createdAt   DateTime @default(now())

  agent       User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId     Int

  @@index([agentId])
}

// --- TABLE DE JONCTION BIEN-CONTACT (Many-to-Many) ---
model PropertyOwner {
  id         Int      @id @default(autoincrement())

  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId Int

  contact    Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId  Int

  createdAt  DateTime @default(now())

  @@unique([propertyId, contactId]) // Un contact ne peut Ãªtre propriÃ©taire qu'une seule fois du mÃªme bien
  @@index([propertyId])
  @@index([contactId])
}