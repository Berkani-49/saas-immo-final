// Fichier : prisma/schema.prisma (VERSION FINALE VALIDÉE)

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// --- UTILISATEURS (Agents) ---
model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  createdAt   DateTime @default(now())

  properties  Property[]
  contacts    Contact[]
  tasks       Task[]
  invoices    Invoice[]
  activities  ActivityLog[]
}

// --- BIENS IMMOBILIERS ---
model Property {
  id          Int      @id @default(autoincrement())
  address     String
  city        String?
  postalCode  String?
  price       Int
  area        Int
  rooms       Int
  bedrooms    Int
  description String?
  
  imageUrl    String?  // Photo
  latitude    Float?   // GPS
  longitude   Float?   // GPS

  createdAt   DateTime @default(now())

  agent       User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId     Int
  tasks       Task[]

  @@index([agentId])
}

// --- CONTACTS (Clients) ---
model Contact {
  id          Int      @id @default(autoincrement())
  firstName   String
  lastName    String
  email       String?
  phoneNumber String?
  type        String   // "BUYER" ou "SELLER"
  createdAt   DateTime @default(now())

  agent       User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId     Int
  tasks       Task[]
  invoices    Invoice[]

  @@index([agentId])
}

// --- TÂCHES ---
model Task {
  id          Int      @id @default(autoincrement())
  title       String
  dueDate     DateTime?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  agent       User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId     Int

  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  contactId   Int?

  property    Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  propertyId  Int?

  @@index([agentId])
  @@index([contactId])
  @@index([propertyId])
}

// --- FACTURES ---
model Invoice {
  id          Int      @id @default(autoincrement())
  ref         String
  amount      Int
  description String
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  // Suppression en CASCADE : Si on supprime le contact, la facture part avec
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId   Int

  agent       User     @relation(fields: [agentId], references: [id])
  agentId     Int
}

// --- HISTORIQUE ---
model ActivityLog {
  id          Int      @id @default(autoincrement())
  action      String
  description String
  createdAt   DateTime @default(now())

  agent       User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId     Int

  @@index([agentId])
}