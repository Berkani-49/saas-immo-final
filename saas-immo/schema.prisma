// Fichier : prisma/schema.prisma (Version FINALE avec Factures + Photos + Carte)

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// --- MOD√àLE USER ---
model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  createdAt   DateTime @default(now())

  // Relations
  properties Property[]
  contacts   Contact[]
  tasks      Task[]
  activities ActivityLog[]
  invoices   Invoice[]
  appointments Appointment[] 
}

// --- MOD√àLE PROPERTY ---
model Property {
  id          Int      @id @default(autoincrement())
  address     String
  city        String?
  postalCode  String?
  price       Int
  area        Int
  rooms       Int
  bedrooms    Int
  description String?

  // Nos ajouts pr√©c√©dents (Photos et Carte)
  imageUrl    String?
  imageUrlEnhanced String? // üì∏ Photo am√©lior√©e par IA
  imageUrlStaged String? // üõãÔ∏è Photo avec home staging virtuel
  stagingStyle String? // Style de staging (moderne, scandinave, etc.)
  latitude    Float?
  longitude   Float?
  views       Int?     @default(0)

  createdAt   DateTime @default(now())

  agent     User @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId   Int
  tasks     Task[]

  // Relation many-to-many avec Contact (propri√©taires)
  owners    PropertyOwner[]

  @@index([agentId])
}

// --- MOD√àLE CONTACT ---
model Contact {
  id          Int      @id @default(autoincrement())
  firstName   String
  lastName    String
  email       String?
  phoneNumber String?
  type        String   // "BUYER" ou "SELLER"
  createdAt   DateTime @default(now())

  // üéØ CRIT√àRES DE RECHERCHE (pour matching automatique)
  budgetMin   Int?     // Budget minimum (‚Ç¨)
  budgetMax   Int?     // Budget maximum (‚Ç¨)
  cityPreferences String? // Villes pr√©f√©r√©es (s√©par√©es par des virgules)
  minBedrooms Int?     // Nombre minimum de chambres
  minArea     Int?     // Surface minimum (m¬≤)

  agent     User @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId   Int
  tasks     Task[]

  // üëá C'est ici qu'on ajoute la ligne pour les factures
  invoices  Invoice[]

  // Relation many-to-many avec Property (biens poss√©d√©s)
  properties PropertyOwner[]

  @@index([agentId])
}

// --- MOD√àLE TASK ---
model Task {
  id          Int      @id @default(autoincrement())
  title       String
  dueDate     DateTime?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  agent     User @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId   Int

  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  contactId   Int?

  property    Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  propertyId  Int?

  @@index([agentId])
  @@index([contactId])
  @@index([propertyId])
}

// --- NOUVEAU MOD√àLE FACTURE (INVOICE) ---
model Invoice {
  id          Int      @id @default(autoincrement())
  ref         String   // Num√©ro de facture
  amount      Int      // Montant
  description String   // Motif
  status      String   @default("PENDING") // PENDING ou PAID
  createdAt   DateTime @default(now())

  // Liens
  contact     Contact @relation(fields: [contactId], references: [id])
  contactId   Int

  agent       User    @relation(fields: [agentId], references: [id])
  agentId     Int
}

// --- MOD√àLE HISTORIQUE D'ACTIVIT√â ---
model ActivityLog {
  id          Int      @id @default(autoincrement())
  action      String   // Ex: "CR√âATION_BIEN", "SUPPRESSION_CONTACT"
  description String   // Ex: "A ajout√© le bien 10 rue de la Paix"
  createdAt   DateTime @default(now())

  agent       User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId     Int

  @@index([agentId])
}

// --- TABLE DE JONCTION BIEN-CONTACT (Many-to-Many) ---
model PropertyOwner {
  id         Int      @id @default(autoincrement())

  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId Int

  contact    Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId  Int

  type       String   @default("OWNER") // "OWNER" (propri√©taire) ou "INTERESTED" (int√©ress√©)
  createdAt  DateTime @default(now())

  @@unique([propertyId, contactId, type]) // Un contact peut √™tre √† la fois propri√©taire ET int√©ress√©
  @@index([propertyId])
  @@index([contactId])
}

// --- MOD√àLE RENDEZ-VOUS (APPOINTMENT) ---
model Appointment {
  id            Int      @id @default(autoincrement())
  clientName    String   // Nom du client
  clientEmail   String   // Email du client
  clientPhone   String?  // T√©l√©phone (optionnel)
  appointmentDate DateTime // Date et heure du RDV
  duration      Int      @default(60) // Dur√©e en minutes (par d√©faut 1h)
  status        String   @default("PENDING") // PENDING, CONFIRMED, CANCELLED
  notes         String?  // Notes optionnelles du client
  createdAt     DateTime @default(now())

  // Lien avec l'agent
  agent         User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId       Int

  @@index([agentId])
  @@index([appointmentDate])
}